<!DOCTYPE html>
<head>
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Overview and querying | gpconnect</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Overview and querying" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="GP Connect aims to support better clinical care by opening up information and data held within GP Practice IT systems for use across health and social care. The GP Connect vision will be achieved by standardising integration and simplifying the operating model." />
<meta property="og:description" content="GP Connect aims to support better clinical care by opening up information and data held within GP Practice IT systems for use across health and social care. The GP Connect vision will be achieved by standardising integration and simplifying the operating model." />
<link rel="canonical" href="http://localhost:4005/integration_spine_directory_service.html" />
<meta property="og:url" content="http://localhost:4005/integration_spine_directory_service.html" />
<meta property="og:site_name" content="gpconnect" />
<script type="application/ld+json">
{"description":"GP Connect aims to support better clinical care by opening up information and data held within GP Practice IT systems for use across health and social care. The GP Connect vision will be achieved by standardising integration and simplifying the operating model.","@type":"WebPage","url":"http://localhost:4005/integration_spine_directory_service.html","headline":"Overview and querying","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Overview of the role of the Spine Directory Services (SDS) within GP Connect">
<meta name="keywords" content="integration,  spine, sds, integration, patient, demographics">
<title>Overview and querying | GP Connect</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>
<script src="js/image-map.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="icon" type="image/png"  href="images/favicon.png">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="gpconnect" href="http://localhost:4005/feed.xml">




    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
	

	<link rel="stylesheet" href="css/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>
        $(document).ready(function(){
		hljs.initHighlightingOnLoad();
		});
    </script>

	
    

	
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> GP Connect API - FHIR&reg; APIs for GP IT systems</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                

                <!-- GitHub icon -->
                <a href="https://github.com/nhsconnect/gpconnect" target="_blank" class="fa fa-github fa-lg navbar-brand no_icon" aria-hidden="true">&nbsp;</a>

                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Overview and querying">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          























<ul id="mysidebar" class="nav">
    <img src="images/logo.png" alt="NHS Digital Logo" height="110" width="110" />
    <li class="sidebarTitle">GP Connect Documents API 1.0.0-beta<br/><span style="font-size: smaller;">FHIR&reg; STU3</span></li>
	<li class="sidebarSection"></li>

    

    
    
    
    <li>
        <a href="#">Overview</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="overview_engage.html">Getting started</a></li>
            
            
            
            
            
            
            <li><a href="overview_priority_capabilities.html">Capabilities</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Release notes</a>
                <ul>
                    
                    
                    
                    <li><a href="overview_release_notes_0_1_0.html">0.1.0</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Design approach</a>
        <ul>
            
            
            
            <li><a href="designprinciples_open_api_principles.html">API design principles</a></li>
            
            
            
            
            
            
            <li><a href="designprinciples_development_principles.html">Development principles</a></li>
            
            
            
            
            
            
            <li><a href="designprinciples_data_model_principles.html">Data model principles</a></li>
            
            
            
            
            
            
            <li><a href="designprinciples_ig_principles.html">Information governance principles</a></li>
            
            
            
            
            
            
            <li><a href="designprinciples_clinical_safety_principles.html">Clinical safety principles</a></li>
            
            
            
            
            
            
            <li><a href="designprinciples_assurance_principles.html">Assurance principles</a></li>
            
            
            
            
            
            
            <li><a href="design_clinical_terminologies.html">Clinical terminologies</a></li>
            
            
            
            
            
            
            <li><a href="design_product_versioning.html">Specification versioning</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Explore</a>
        <ul>
            
            
            
            <li><a href="system_demonstrator.html">System demonstrator</a></li>
            
            
            
            
            
            
            <li><a href="system_swagger.html">Interactive API documentation</a></li>
            
            
            
            
            
            
            <li><a href="system_reference_postman.html">Postman API examples</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Development</a>
        <ul>
            
            
            
            <li><a href="development_deliverables.html">Development deliverables</a></li>
            
            
            
            
            
            
            <li><a href="development_fhir_open_source_guidance.html">FHIR&reg; library</a></li>
            
            
            
            
            
            
            <li><a href="development_fhir_api_guidance.html">FHIR&reg; implementation</a></li>
            
            
            
            
            
            
            <li><a href="development_general_api_guidance.html">General API guidance</a></li>
            
            
            
            
            
            
            <li><a href="development_branch_surgeries.html">Branch surgeries</a></li>
            
            
            
            
            
            
            <li><a href="development_fhir_resource_guidance.html">FHIR&reg; resources</a></li>
            
            
            
            
            
            
            <li><a href="development_api_security_guidance.html">Security</a></li>
            
            
            
            
            
            
            <li><a href="development_fhir_error_handling_guidance.html">Error handling</a></li>
            
            
            
            
            
            
            <li><a href="development_api_volume_and_performance.html">Volumetric and performance</a></li>
            
            
            
            
            
            
            <li><a href="development_api_non_functional_requirements.html">Non-functional requirements</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Implement a capability</a>
        <ul>
            
            
            
            <li><a href="foundations.html">Foundations</a></li>
            
            
            
            
            
            
            <li><a href="appointments.html"><b class="capability-not-available">Appointment Management</b></a></li>
            
            
            
            
            
            
            <li><a href="accessrecord_structured.html"><b class="capability-not-available">Access Record Structured</b></a></li>
            
            
            
            
            
            
            <li><a href="accessrecord_documents_development.html">Access Record Documents</a></li>
            
            
            
            
            
            
            <li><a href="accessrecord.html"><b class="capability-not-available">Access Record HTML</b></a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Integrate with Spine</a>
        <ul>
            
            
            
            <li><a href="integration_illustrated.html">Spine integration illustrated</a></li>
            
            
            
            
            
            
            <li><a href="integration_system_topologies.html">System topologies</a></li>
            
            
            
            
            
            
            <li><a href="integration_cross_organisation_audit_and_provenance.html">Cross-organisation audit and provenance</a></li>
            
            
            
            
            
            
            <li><a href="integration_personal_demographic_service.html">Personal Demographic Service</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Spine Directory Services</a>
                <ul>
                    
                    
                    
                    <li class="active"><a href="integration_spine_directory_service.html">Overview and querying</a></li>
                    
                    
                    
                    
                    
                    <li><a href="integration_sds_registering_endpoints.html">Registering systems</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="integration_interaction_ids.html">Interaction IDs</a></li>
            
            
            
            
            
            
            <li><a href="integration_spine_secure_proxy.html">Spine Secure Proxy</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Test and assure</a>
        <ul>
            
            
            
            <li><a href="testing_deliverables.html">Testing assets</a></li>
            
            
            
            
            
            
            <li><a href="testing_environments.html">Test environments</a></li>
            
            
            
            
            
            
            <li><a href="testing_api_provider_testing.html">Provider testing</a></li>
            
            
            
            
            
            
            <li><a href="testing_api_consumer_testing.html">Consumer testing</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Help and support</a>
        <ul>
            
            
            
            <li><a href="support_faq.html">Frequently asked questions</a></li>
            
            
            
            
            
            
            <li><a href="overview_glossary.html">Glossary</a></li>
            
            
            
            
            
            
            <li><a href="support_communications.html">Communication channels</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">External links</a>
                <ul>
                    
                    
                    
                    <li><a href="https://github.com/nhsconnect/gpconnect" target="_blank">GPC Documentation repository</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://digital.nhs.uk/services/gp-connect" target="_blank">GPC NHS Digital</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://github.com/nhsconnect/gpconnect-fhir/" target="_blank">GPC GitHub FHIR data library</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://github.com/nhsconnect/gpconnect-dotnet-examples/" target="_blank">GPC GitHub C# examples</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://github.com/nhsconnect/gpconnect-java-examples/" target="_blank">GPC GitHub Java examples</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://github.com/nhsconnect/gpconnect-provider-testing/" target="_blank">GPC GitHub provider test harness</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            <li class="subfolders">
                <a href="#">Tags</a>
                <ul>
                    
                    
                    
                    <li><a href="tag_getting_started.html">Getting started</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_first_of_type.html">First of Type</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_fhir.html">FHIR&reg;</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_structured.html">Structured</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_foundations.html">Foundations</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_htmlgetcarerecord.html">HTML Get Care Record</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_getcarerecord.html">Get Care Record</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_appointments.html">Appointments</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_engagement.html">Engagement</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_design.html">Design</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_development.html">Development</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_integration.html">Integration</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_testing.html">Testing</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_assurance.html">Assurance</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_deployment.html">Deployment</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_support.html">Support</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_clinical_safety.html">Clinical safety</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_information_governance.html">Information governance</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_commissioning.html">Commissioning</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_code_snippet.html">Code snippet</a></li>
                    
                    
                    
                    
                    
                    <li><a href="tag_usecase.html">Use case</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="support_run_website_locally.html">Run website locally</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
         




 <div markdown="span" class="alert alert-danger" role="alert">
	<i class="fa fa-exclamation-circle"></i>
	<b>Version:</b> This is a <b>pre-release (draft) version</b> of the GP Connect API specification and is subject to change. For the current version and other specifications, please visit <a href="https://developer.nhs.uk/gp-connect-specification-versions/">GP Connect specifications page</a>.
</div>

 

<div class="post-header">
   <h1 class="post-title-main">Overview and querying</h1>
</div>





<div class="post-content">

   
    <div class="summary">Overview of the role of the Spine Directory Services (SDS) within GP Connect</div>
   

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    

  <h2 id="overview">Overview</h2>

<p>Spine Directory Service (SDS) is an endpoint and identifier directory for Spine and Spine connected systems, containing information on accredited systems, services and NHS registered users.  It is accessed via the Lightweight Directory Access Protocol (LDAP).</p>

<p>GP Connect provider and consumer systems are registered in SDS in order to enable:</p>

<ul>
  <li>Consumer systems to lookup provider system’s ASID and endpoint information</li>
  <li>The Spine Secure Proxy to allow or deny requests based on known identifier and endpoint information
<br /></li>
</ul>

<p><strong>AS records</strong></p>

<p>Every system that connects to the Spine has one or more “Accredited System” (AS) records in SDS, identified by an Accredited System Identifier (ASID).</p>

<p>This ASID is unique to a system deployed in a specific organisation, so the same application deployed into three NHS organisations would typically be represented as three unique ASIDs.</p>

<p><strong>MHS records and endpoints</strong></p>

<p>Every GP Connect system also has one or more “MHS” records (or message handling server record), identified by Party Key and <a href="integration_interaction_ids.html">Interaction ID</a>.</p>

<p>MHS records of GP Connect provider systems contain the endpoint of the target practice, as defined by the <a href="development_general_api_guidance.html#service-root-url">FHIR service root URL</a>.</p>

<p>Please see <a href="integration_system_topologies.html">System topologies</a> for more details on the allocation of ASIDs and Party Keys.</p>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> <strong>Distinguishing GP Connect provider and consumer SDS records</strong><br />
Providers have GP Connect <a href="integration_interaction_ids.html">interaction IDs</a> on their MHS records; consumers do not.  This distinction enables the SDS queries below to return the correct record, where a provider organisation has seperate consumer systems in addition to their main provider system.</div>

<h2 id="querying-sds">Querying SDS</h2>

<h2 id="looking-up-a-providers-endpoint-and-asid">Looking up a provider’s endpoint and ASID</h2>

<p>GP Connect consumer systems are expected to resolve the <a href="development_general_api_guidance.html#service-root-url">FHIR service root URL</a> and ASID for a given GP provider organisation using <a href="http://digital.nhs.uk/spine">Spine Directory Service (SDS)</a> LDAP directory lookups.</p>

<p>This is a two step process, as follows:</p>

<blockquote>
  <ol>
    <li>Lookup the Message Handling System (MHS) record</li>
    <li>Lookup the Accredited System (AS) record</li>
  </ol>
</blockquote>

<p>The process allows a consumer system to retrieve the following details for a target GP provider organisation:</p>

<ul>
  <li>FHIR service root URL, retrieved from the <code class="highlighter-rouge">nhsMhsEndpoint</code> element in step 1</li>
  <li>And the ASID, retrieved from <code class="highlighter-rouge">uniqueIdentifier</code> element in step 2</li>
</ul>

<p>The FHIR service root URL is used to <a href="#step-3-consumer-constructs-full-gp-connect-request-url-to-be-sent-to-the-spine-security-proxy">construct the full target URL for a GP Connect request</a>. The provider’s ASID is sent in the  <code class="highlighter-rouge">Ssp-To</code> HTTP header.</p>

<p>Please see below for more detail on the process.</p>

<p>Systems <strong>SHOULD</strong> cache SDS query results giving details of consuming system, endpoints and endpoint capability on a per session basis.</p>

<p>Systems <strong>MUST NOT</strong> cache and re-use consuming system endpoint information derived from SDS across multiple patient encounters or practitioner usage sessions. Each new patient encounter will result in new lookups to ascertain the most up-to-date consuming system, endpoint and endpoint capability.</p>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> <strong>Why have SDS queries changed in GP Connect API 1.2.3?</strong><br />
The SDS queries in this version of the specification allow consumers to return the correct endpoint and ASID for a provider GP practice where the practice has multiple GP Connect ASIDs - this occurs where the practice is running one or more seperate GP Connect consumer systems (with their own ASIDs), in addition to their principal clinical system acting as a provider and consumer.<br />
The SDS queries in GP Connect API 1.2.2 and prior versions do not support this configuration, hence existing consumer systems <strong>MUST</strong> update their queries to to this version of the specification.</div>

<h3 id="step-1-message-handling-system-mhs-record-lookup">Step 1: Message Handling System (MHS) record lookup</h3>

<p>Consumer systems <strong>MUST</strong> lookup the FHIR service root URL and Party Key from the MHS record, using the ODS code of the target practice, as follows:</p>

<p><strong>Search criteria:</strong></p>
<ul>
  <li>Organisation code
    <ul>
      <li><code class="highlighter-rouge">nhsIDCode</code> = <em>ODS code</em> of the target organisation (for example, GP practice)</li>
    </ul>
  </li>
  <li>Message Handling System type
    <ul>
      <li><code class="highlighter-rouge">objectClass</code> = <code class="highlighter-rouge">nhsMHS</code></li>
    </ul>
  </li>
  <li>MHS Interaction ID
    <ul>
      <li><code class="highlighter-rouge">nhsMhsSvcIA</code> = <em>Interaction ID</em>, please see GP Connect <a href="integration_interaction_ids.html">Interaction IDs</a></li>
    </ul>
  </li>
</ul>

<p><strong>Result attributes:</strong></p>
<ul>
  <li>Target organisation’s FHIR service root URL
    <ul>
      <li><code class="highlighter-rouge">nhsMhsEndPoint</code></li>
    </ul>
  </li>
  <li>Target organisation’s Party Key
    <ul>
      <li><code class="highlighter-rouge">nhsMhsPartyKey</code></li>
    </ul>
  </li>
</ul>

<p><strong>ldapsearch query:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldaps://ldap.vn03.national.ncrs.nhs.uk <span class="nt">-b</span> <span class="s2">"ou=services, o=nhs"</span> 
	<span class="s2">"(&amp;(nhsidcode=[odsCode]) (objectClass=nhsMhs) (nhsMhsSvcIA=[interactionId]))"</span>
	nhsMhsEndPoint nhsMhsPartyKey	
</code></pre></div></div>

<h3 id="step-2-accredited-system-record-lookup">Step 2: Accredited System record lookup</h3>

<p>Consumer systems <strong>MUST</strong> use the Party Key retrieved in Step 1 along with the practice’s ODS code, in order to determine the ASID of the target practice, as follows:</p>

<p><strong>Search criteria:</strong></p>
<ul>
  <li>Organisational code
    <ul>
      <li><code class="highlighter-rouge">nhsIDCode</code> = <em>ODS code</em> of the target organisation (for example, GP practice)</li>
    </ul>
  </li>
  <li>Accredited System type
    <ul>
      <li><code class="highlighter-rouge">objectClass</code> = <code class="highlighter-rouge">nhsAs</code></li>
    </ul>
  </li>
  <li>MHS Party Key
    <ul>
      <li><code class="highlighter-rouge">nhsMHSPartyKey</code> = Target organisation’s <em>Party key</em> as retrieved from the <code class="highlighter-rouge">nhsMhsPartyKey</code> attribute in step 1</li>
    </ul>
  </li>
</ul>

<p><strong>Result attributes:</strong></p>
<ul>
  <li>Target organisation’s ASID
    <ul>
      <li><code class="highlighter-rouge">uniqueIdentifier</code></li>
    </ul>
  </li>
</ul>

<p><strong>ldapsearch query:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldaps://ldap.vn03.national.ncrs.nhs.uk –b <span class="s2">"ou=services, o=nhs"</span> 
	<span class="s2">"(&amp;(nhsidcode=[odsCode]) (objectclass=nhsAs) (nhsMHSPartyKey=[nhsMHSPartyKey]))"</span>
	uniqueIdentifier	
</code></pre></div></div>

<h2 id="worked-example---looking-up-a-providers-endpoint-and-asid">Worked example - looking up a provider’s endpoint and ASID</h2>

<p><strong>Given</strong>
A consuming system which needs to get the structured record of a patient record at the patient’s registered practice. The consuming system has the following information about the patient:</p>
<ul>
  <li>NHS number</li>
  <li>a set of demographic details about the patient</li>
</ul>

<p><strong>When</strong>
The consuming system interacts with GP Connect</p>

<p><strong>Then</strong> 
The following steps <strong>MUST</strong> be followed:</p>

<h3 id="step-0-pds-trace-pre-requisite-step">Step 0: PDS trace (pre-requisite step)</h3>

<p>The consuming system is responsible for <a href="integration_personal_demographic_service.html">performing a PDS trace</a> to both verify the identity of the patient and retrieve the ODS code of the patient’s registered primary care practice.</p>

<p>For this example, NHS number 9000000084 with demographic details Mr Anthony Tester, 19 Fictitious Avenue, Testtown returns the ODS code T99999.</p>

<h3 id="step-1-mhs-record-lookup-on-sds-to-determine-fhir-endpoint-server-root-url">Step 1: MHS record lookup on SDS to determine FHIR endpoint server root URL</h3>

<p>Using the ODS code retrieved from Step 0, and the interaction ID of the required service, the following ldapsearch query is executed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch -x -H ldaps://ldap.vn03.national.ncrs.nhs.uk -b "ou=services, o=nhs" 
"(&amp;(nhsIDCode=T99999) (objectClass=nhsMhs) (nhsMhsSvcIA=urn:nhs:names:services:gpconnect:fhir:operation:gpc.getstructuredrecord-1))" 
nhsMhsEndPoint nhsMhsPartyKey
</code></pre></div></div>

<p>This query should return a single endpoint. In this case, the ldapquery returns the following results:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 472b35d4641b76454b13, Services, nhs
dn: uniqueIdentifier=472b35d4641b76454b13,ou=Services,o=nhs
nhsMhsEndPoint: https://pcs.thirdparty.nhs.uk/T99999/STU3/1
nhsMhsPartyKey: T99999-9999999

# search result
search: 1
result: 0 Success
</code></pre></div></div>

<h3 id="step-2-as-record-lookup-on-sds-to-determine-the-providers-asid">Step 2: AS record lookup on SDS to determine the provider’s ASID</h3>

<p>The ASID is now looked up on SDS. The example below uses ldapsearch:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch -x -H ldaps://ldap.vn03.national.ncrs.nhs.uk –b "ou=services, o=nhs" 
"(&amp;(nhsIDCode=T99999) (objectClass=nhsAS) (nhsMHSPartyKey=T99999-9999999))" 
uniqueIdentifier 
</code></pre></div></div>

<p>This query should return a single matching accredited system object from SDS, the ASID being found in the uniqueIdentifier attribute. In this case, the ldapquery returns the following results:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>999999999999, Services, nhs
dn: uniqueIdentifier=9999999999,ou=Services,o=nhs
uniqueIdentifier: 999999999999

# search result
search: 1
result: 0 Success
</code></pre></div></div>

<h3 id="step-3-consumer-constructs-full-gp-connect-request-url-to-be-sent-to-the-spine-security-proxy">Step 3: Consumer constructs full GP Connect request URL to be sent to the Spine Security Proxy</h3>

<p>The format of the full URL which the consuming system is responsible for constructing is as follows:</p>

<p><code class="highlighter-rouge">https://[ssp_fqdn]/[provider_service_root_url]/[fhir_request]</code></p>

<p>The value returned in the <code class="highlighter-rouge">nhsMhsEndPoint</code> attribute in Step 1 should be treated as the <code class="highlighter-rouge">[provider_service_root_url]</code> at the provider system.</p>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> The SSP will reject requests where the <code class="highlighter-rouge">[provider_service_root_url]</code> portion of the above URL does not match that held in SDS (in the <code class="highlighter-rouge">nhsMhsEndPoint</code> attribute). Consumer systems must take care not to amend this portion, for example replacing the domain name with an equivalent IP address, or adding an explicit <code class="highlighter-rouge">:443</code> port declaration.</div>

<p>In this example, to issue a Get Structured Record request, the following request would be made:</p>

<p><code class="highlighter-rouge">POST https://testspineproxy.nhs.domain.uk/https://pcs.thirdparty.nhs.uk/T99999/STU3/1/Patient/$gpc.getstructuredrecord</code></p>

<h2 id="sds-tls-configuration">SDS TLS configuration</h2>

<p>SDS requires TLS Mutual Authentication. It is therefore necessary to configure ldapsearch in the examples above with the certificates necessary to verify the authenticity of the SDS LDAP server, and also to enable SDS to verify the spine endpoint making the LDAP request:</p>

<ol>
  <li>Root and SubCA Spine development certificates available from Assurance Support</li>
  <li>Obtain a client certificate by submitting a certificate signing request for your development endpoint to Assurance Support</li>
</ol>

<h2 id="looking-up-a-consumers-own-asid">Looking up a consumer’s own ASID</h2>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> This LDAP query is for a consumer system to lookup their <em>own</em> ASID. To determine the provider’s ASID and endpoint, please see the queries above.</div>

<p>A consumer is required to populate their ASID in the <code class="highlighter-rouge">Ssp-From</code> HTTP header when sending a GP Connect request.</p>

<p>Consumer systems deployed at many sites may prefer to dynamically query their own ASID instead of holding as local configuration.</p>

<p>Consumer system suppliers wishing to do this should be aware that there may be more than one GP Connect consumer system deployed at an organisation, and hence multiple AS records for a given ODS code.</p>

<p>In order to ensure the right AS record and ASID is retrieved, an additional search field should be used - <code class="highlighter-rouge">nhsMhsManufacturerOrg</code> is recommended - which will filter out AS records from other suppliers.</p>

<p>AS record lookup on SDS to determine the consumer’s ASID.</p>

<p><strong>Search criteria:</strong></p>
<ul>
  <li>Organisational code
    <ul>
      <li><code class="highlighter-rouge">nhsIDCode</code> = <em>ODS code</em> of the consumer organisation</li>
    </ul>
  </li>
  <li>Accredited System type
    <ul>
      <li><code class="highlighter-rouge">objectClass</code> = <code class="highlighter-rouge">nhsAs</code></li>
    </ul>
  </li>
  <li>AS Interaction ID
    <ul>
      <li><code class="highlighter-rouge">nhsAsSvcIA</code> = <em>Interaction ID</em>, please see GP Connect <a href="integration_interaction_ids.html">Interaction IDs</a></li>
    </ul>
  </li>
  <li>Manufacturer of the consumer system (the <em>ODS code</em> of the manufacturer of the consumer system)
    <ul>
      <li><code class="highlighter-rouge">nhsMhsManufacturerOrg</code> = <em>ODS code</em> of the consumer system supplier</li>
    </ul>
  </li>
</ul>

<p><strong>Result attributes:</strong></p>
<ul>
  <li>Consumer’s ASID
    <ul>
      <li><code class="highlighter-rouge">uniqueIdentifier</code></li>
    </ul>
  </li>
</ul>

<p><strong>ldapsearch query:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldaps://ldap.vn03.national.ncrs.nhs.uk –b <span class="s2">"ou=services, o=nhs"</span>
	<span class="s2">"(&amp;(nhsIDCode=[odsCode]) (objectClass=nhsAS) (nhsaASvcIA=[interactionId]) (nhsMhsManufacturerOrg=[odsCode]))"</span>
	uniqueIdentifier 
</code></pre></div></div>



    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        <a href="tag_integration.html" class="btn btn-default navbar-btn cursorNorm" role="button">integration</a>
        
        
        
    </div>

    

</div>


<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                    <img class="pull-left" src="images/explanatoryline.png" alt="NHS Digital Explanatory Line"/>
                    <br/>
                    &copy;2019 NHS Digital<br />
                     Site last generated: Sep 23, 2019 <br />
                    <br/>
                    <br/>
                    <!-- OGL Licence -->
                    <div class="open-government-licence">
                        <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license" class="no_icon"><img src="images/licence/ogl-symbol-41px-retina-black.png"></img></a>
                        <p>All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license" class="no_icon">Open Government Licence v3.0</a>, except where otherwise stated</p>
                    </div>
                    <div style="font-size: larger;"><a href="accessibility.html">Accessibility</a> | <a href="https://help.github.com/articles/github-privacy-statement/">Privacy</a> | <a href="support_communications.html">Contact us</a></div>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>
